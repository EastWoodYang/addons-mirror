name: "Sync"

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: |
          rm -rf ./temp
          git clone -q --single-branch --depth=1 --branch=master https://github.com/hassio-addons/repository.git temp
          
      - name: Create local changes
        run: |
          rm -rf ./temp/.git
          rm -rf ./temp/.github
          rm -rf ./temp/.devcontainer
          rm -rf ./temp/.vscode

          for d in ./temp/* ; do
              if [ -f "$d/config.yaml" ]; then
                sed -i 's/image: ghcr.io/image: ghcr.nju.edu.cn/' $d/config.yaml
              fi
          done
          shopt -s extglob
          rm -rf !(.git)
          shopt -u extglob
          cp -r ./temp/* ./
          rm -rf ./temp


      - name: Commit files
        run: |
          git config --local user.email "github-actions@github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          git commit -a -m "Sync."

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}